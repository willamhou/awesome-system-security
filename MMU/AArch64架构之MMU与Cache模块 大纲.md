# 模块知识介绍顺序

1. MMU和Cache是什么 ，它们是用来解决什么问题的，为什么需要它们（What & Why）

2. MMU和Cache的实现原理（How）

## 1. 目标人群

这个大纲是从“小白视角”出发而拟写的。目标人群是有过一些软件开发经验，但在操作系统或硬件架构上还是新手的人群。按照入门的“路书”的方式而写。

# 1. 背景知识：内存与地址

## 引言

计算机软件的发展，是和硬件的发展息息相关的。冯诺依曼架构？

MMU和Cache，是CPU中重要的内存访问硬件模块。然而，它们跟软件的特性开发又有着密切的联系。从CPU内存访问的演进视角，让我们重新回顾下，内存与地址的演进逻辑。

## 1.1 冯诺依曼架构

冯诺依曼架构，CPU处理器，内存，指令，传送带模型 etc

## 1.2 CPU取址的演进：8bit，32位，64位

取址的目的，为什么要取址。早期取址技术，以及arm32 与 arm64

## 1.3 内存隔离：虚拟地址

程序为什么需要虚拟地址？虚拟地址初认识。

虚拟地址技术的实现：分页技术。

# 2. MMU和Cache：CPU的内存访问模型

## 引言

1. 什么是MMU和Cache？（粗略介绍，以图书馆中找书为例）

2. CPU的内存访问架构。CPU，总线，MMU TLB, DDR etc。

3. 访问工作流。CPU -> Cache(TLB) -> MMU

## 2.1 MMU介绍

页表概念、多级页表。

页表权限管理。

提一下TLB。

## 2.2 Cache介绍

解释Cache存在的意义和它的层次结构。

为什么要Cache？

* 数据： CPU速度 >> 内存速度。CPU等数据从内存来，就像F1赛车在等拖拉机送货。

* 解决方案： 在CPU和内存之间设置一个高速缓存（Cache），就像是一个“办公桌”。

* 比喻： CPU（你）需要处理文件（数据）。仓库（内存）很远，每次取文件都跑一趟效率极低。于是你在办公室放了一张桌子（Cache），把最近常用和即将要用的文件放在桌上，伸手就能拿到，速度极快。

1. Cache的层次结构：L1, L2, L3

   * 比喻： 你的“办公桌”也有不同区域。

     * L1 Cache： 你手正在写的文件。最快最小，紧挨着CPU核心。

     * L2 Cache： 桌面上其他的文件。速度中等，容量中等。

     * L3 Cache： 桌子旁边的推车。最慢最大，但依然比去仓库快得多，通常被一个芯片上的多个核心共享。

   * 结论：CPU找数据时，按 L1 -> L2 -> L3 -> 内存 的顺序去找，找到就返回，找不到才继续往下，目的是尽可能快地拿到数据。

2. Cache的工作方式（核心概念）

   * 缓存行（Cache Line）： Cache拷贝数据的最小单位（比如64字节）。它不是一个个字节拷贝，而是一次拷贝一小块。

   * 命中（Hit）与缺失（Miss）： 数据在Cache里叫“命中”，皆大欢喜；不在Cache里叫“缺失”，需要去内存取，性能损耗。

## 2.3 双剑合璧——MMU与Cache如何协作

* 目标： 将两个概念联系起来，形成整体认知。

* 内容：

  * CPU发出一个虚拟地址。

  * 第一步： MMU将这个虚拟地址翻译成物理地址（这个过程可能会用到TLB这个小抄）。

  * 第二步： 得到物理地址后，CPU不是直接去内存找，而是拿着这个物理地址先去Cache里看看有没有缓存副本。

  * 第三步： 如果Cache命中，直接返回数据给CPU；如果缺失，才去内存读取，并按照策略放入Cache以备后续使用。

  * 流程图： `虚拟地址 -> (MMU翻译) -> 物理地址 -> (查询Cache) -> 命中/缺失 -> 返回数据/访问内存`

# 3. AArch64下的MMU和Cache

## 引言

主要介绍架构，为什么这两个模块要考虑架构实现。（回到硬件与软件的紧密合作）

拨开操作系统的封装，让我们研究下如何用代码实现Arm的页表配置。

## 1. MMU相关的CPU系统寄存器介绍

* 什么是系统寄存器？（稍微提一下）

* 分别有哪些？ ttbr sctlr tcr mair

* 这些系统寄存器是用来做什么的

## 3.2 AArch64的页表

* aarch64支持几级页表？多少位的虚拟地址和物理地址？（不知道分页的往前看）

* 页表类型(table, page, block)，页表的属性(attr)介绍

* 举个例子

* 一些要点：BBM，大页拆分导致的缺页问题，核间通信

## 3.3 Cache相关的硬件配置（详细看下）

* 和MMU一样，SCTLR, tlb指令，etc

* CPU会如何受这些配置影响

## 3.4 Arm64的Cache的介绍

Way, set, valid, invalid, flush, etc

Cache的取址原理

代码例子：刷cache为例

# 4. 总结

Cache和MMU的作用，工作原理。架构上的主要特点。常见的实践。

中间提到的一些非MMU和Cache的概念，比如BBM的核间中断，指向我们的新资料。

